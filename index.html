<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Essais cliniques</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --primary:#0b5aa2; --accent:#e44d26; --bg:#ffffff; --muted:#f4f6f8;
      --text:#1f2937; --border:#e5e7eb;
    }
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--text); margin:0;}
    header{ padding:20px 16px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#fff,#fafafa);}
    h1{ margin:0; font-size:1.4rem; color:var(--primary);}
    .container{ max-width:1100px; margin:0 auto; padding:16px;}
    .toolbar{ display:grid; gap:8px; grid-template-columns:1fr repeat(4,minmax(120px,180px)); align-items:center; margin:10px 0 14px;}
    .toolbar>*{ width:100%;}
    input,select,button{ padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:14px;}
    button{ cursor:pointer; border:1px solid var(--primary); background:var(--primary); color:#fff; font-weight:600;}
    button.secondary{ background:#fff; color:var(--primary);}
    table{ width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 1px 2px rgba(0,0,0,0.04);}
    thead th{ text-align:left; background:var(--muted); border-bottom:1px solid var(--border); padding:10px; font-size:13px; color:#374151; user-select:none; cursor:pointer;}
    tbody td{ border-bottom:1px solid var(--border); padding:10px; font-size:14px;}
    tbody tr:hover{ background:#fcfcfd;}
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;}
    .chip{ background:#eef6ff; color:#0b5aa2; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #dbeafe;}
    .footer{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:10px;}
    .pagination{ display:flex; gap:6px;}
    .pagination button{ padding:8px 10px;}
    @media (max-width:900px){ .toolbar{ grid-template-columns:1fr 1fr; } }
    @media print { header,.toolbar,.footer{ display:none!important;} table{ box-shadow:none;} body{ background:#fff;} }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Essais cliniques</h1>
      <div class="chips" id="summary"></div>
      <div style="color:#6b7280;font-size:13px">Source : <code>yoyo.csv</code> (auto-détection du séparateur)</div>
    </div>
  </header>

  <main class="container">
    <div class="toolbar">
      <input id="q" type="search" placeholder="Rechercher (Titre, Centre, Population, Notes, Contact, ...)" />
      <select id="phase"><option value="">Phase (toutes)</option></select>
      <select id="statut"><option value="">Statut (tous)</option></select>
      <select id="categorie"><option value="">Catégorie (toutes)</option></select>
      <div style="display:flex; gap:8px;">
        <button id="exportCsv" class="secondary" title="Exporter la vue en CSV">Exporter CSV</button>
        <button id="exportJson" class="secondary" title="Exporter la vue en JSON">Exporter JSON</button>
        <button id="print">Imprimer</button>
      </div>
    </div>

    <table id="table">
      <thead>
        <tr>
          <th data-key="ID">ID</th>
          <th data-key="Titre">Titre</th>
          <th data-key="Phase">Phase</th>
          <th data-key="Statut">Statut</th>
          <th data-key="Categorie">Catégorie</th>
          <th data-key="Centre">Centre</th>
          <th data-key="Population">Population</th>
          <th data-key="Notes">Notes</th>
          <th data-key="Contact">Contact</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="footer">
      <div id="count"></div>
      <div class="pagination">
        <button id="prev" class="secondary">Précédent</button>
        <span id="pageInfo" style="padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;"></span>
        <button id="next">Suivant</button>
      </div>
    </div>
  </main>

  <!-- PapaParse (CSV parser) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // ===== Helpers robustes =====
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const uniq = arr => [...new Set(arr.filter(Boolean))].sort((a,b)=>(''+a).localeCompare(''+b,'fr',{numeric:true,sensitivity:'base'}));
    const contains = (hay, needle) => !needle || (hay||'').toString().toLowerCase().includes((needle||'').toLowerCase());

    function stripBOM(s){ return typeof s==='string' ? s.replace(/^\uFEFF/, '') : s; }
    function normKey(k){
      return stripBOM((k||'')+'')
        .trim()
        .toLowerCase()
        .normalize('NFD').replace(/\p{Diacritic}/gu,'')
        .replace(/\s+/g,'');
    }
    function pick(row, aliases){
      const map = {};
      for (const k of Object.keys(row)) map[normKey(k)] = row[k];
      for (const a of aliases){
        const na = normKey(a);
        if (na in map) return map[na];
      }
      return '';
    }

    // ===== État =====
    let rows = [], filtered = [];
    let sortKey = null, sortDir = 1;
    const pageSize = 10; let page = 1;

    // ===== Rendu =====
    function renderSummary(){
      const chips = [];
      const q = $('#q').value.trim(), p = $('#phase').value, s = $('#statut').value, c = $('#categorie').value;
      if(q) chips.push(`Recherche: “${q}”`);
      if(p) chips.push(`Phase: ${p}`);
      if(s) chips.push(`Statut: ${s}`);
      if(c) chips.push(`Catégorie: ${c}`);
      $('#summary').innerHTML = chips.map(t=>`<span class="chip">${t}</span>`).join('');
    }

    function renderTable(){
      const total = filtered.length, totalPages = Math.max(1, Math.ceil(total / pageSize));
      page = Math.min(Math.max(1,page), totalPages);
      const slice = filtered.slice((page-1)*pageSize, page*pageSize);

      $('#table tbody').innerHTML = slice.map(r=>`
        <tr>
          <td>${r.ID??''}</td>
          <td>${r.Titre??''}</td>
          <td>${r.Phase??''}</td>
          <td>${r.Statut??''}</td>
          <td>${r.Categorie??''}</td>
          <td>${r.Centre??''}</td>
          <td>${r.Population??''}</td>
          <td>${r.Notes??''}</td>
          <td>${r.Contact??''}</td>
        </tr>
      `).join('');

      $('#count').textContent = `${total} essai(s) • Page ${page}/${totalPages}`;
      $('#pageInfo').textContent = `Page ${page}/${totalPages}`;
      $('#prev').disabled = page<=1; $('#next').disabled = page>=totalPages;
    }

    // ===== Logique =====
    function applyFilters(){
      const q = $('#q').value.trim(), p = $('#phase').value, s = $('#statut').value, c = $('#categorie').value;
      filtered = rows
        .filter(r =>
          contains(r.Titre,q) ||
          contains(r.Centre,q) ||
          contains(r.Phase,q) ||
          contains(r.Statut,q) ||
          contains(r.Categorie,q) ||
          contains(r.Population,q) ||
          contains(r.Notes,q) ||
          contains(r.Contact,q)
        )
        .filter(r => p ? r.Phase===p : true)
        .filter(r => s ? r.Statut===s : true)
        .filter(r => c ? r.Categorie===c : true);

      if(sortKey){
        filtered.sort((a,b)=>{
          const av = (a[sortKey]??'').toString();
          const bv = (b[sortKey]??'').toString();
          return av.localeCompare(bv,'fr',{numeric:true,sensitivity:'base'}) * sortDir;
        });
      }
      page = 1; renderSummary(); renderTable();
    }

    function populateFilters(){
      const phases = uniq(rows.map(r=>r.Phase));
      const statuts = uniq(rows.map(r=>r.Statut));
      const categories = uniq(rows.map(r=>r.Categorie));
      $('#phase').innerHTML = '<option value="">Phase (toutes)</option>' + phases.map(v=>`<option>${v}</option>`).join('');
      $('#statut').innerHTML = '<option value="">Statut (tous)</option>' + statuts.map(v=>`<option>${v}</option>`).join('');
      $('#categorie').innerHTML = '<option value="">Catégorie (toutes)</option>' + categories.map(v=>`<option>${v}</option>`).join('');
    }

    function exportCurrentToCSV(){
      if(!filtered.length) return;
      const header = Object.keys(filtered[0]);
      const lines = [
        header.join(','),  // séparateur virgule
        ...filtered.map(r=>header.map(k=>{
          const cell = (r[k]??'').toString().replaceAll('"','""');
          return /[,\"\n]/.test(cell) ? `"${cell}"` : cell;
        }).join(','))
      ];
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'essais_filtrés.csv';
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    }
    function exportCurrentToJSON(){
      const blob = new Blob([JSON.stringify(filtered,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'essais_filtrés.json';
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    }

    function initEvents(){
      $('#q').addEventListener('input', applyFilters);
      $('#phase').addEventListener('change', applyFilters);
      $('#statut').addEventListener('change', applyFilters);
      $('#categorie').addEventListener('change', applyFilters);
      $('#print').addEventListener('click', ()=>window.print());
      $('#exportCsv').addEventListener('click', exportCurrentToCSV);
      $('#exportJson').addEventListener('click', exportCurrentToJSON);
      $('#prev').addEventListener('click', ()=>{ page=Math.max(1,page-1); renderTable(); });
      $('#next').addEventListener('click', ()=>{ page=page+1; renderTable(); });
      $$('#table thead th').forEach(th=>{
        th.addEventListener('click', ()=>{
          const key = th.getAttribute('data-key');
          if(sortKey===key) sortDir = -sortDir; else { sortKey = key; sortDir = 1; }
          applyFilters();
        });
      });
    }

    // ===== Chargement CSV avec auto-détection & normalisation =====
    function onCsvLoaded(data){
      // ordre des clés = ordre d'insertion -> contrôle l'export
      rows = data.map(r => ({
        ID:         pick(r, ['id','identifiant','code']),
        Titre:      pick(r, ['titre','title','nom','nomdessai','essai']),
        Phase:      pick(r, ['phase']),
        Statut:     pick(r, ['statut','status','etat']),
        Categorie:  pick(r, ['categorie','catégorie','category']),
        Centre:     pick(r, ['centre','site','hopital','hôpital']),
        Population: pick(r, ['population','patients','cohorte']),
        Notes:      pick(r, ['notes','remarques','commentaires','commentaireslibres']),
        Contact:    pick(r, ['contact','email','courriel','telephone','téléphone'])
      }));
      populateFilters(); applyFilters();
    }

    function loadCSV(){
      Papa.parse('essais.csv', {
        download: true,
        header: true,
        skipEmptyLines: 'greedy',
        delimitersToGuess: [',',';','\t','|'],
        complete: (res)=> onCsvLoaded(res.data),
        error: (err)=> alert('Erreur de chargement du CSV : ' + (err?.message||err))
      });
    }

    // Démarrage
    initEvents();
    loadCSV();
  </script>
</body>
</html>
