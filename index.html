<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Essais cliniques</title>
  <link rel="icon" href="data:,">
  <style>
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin:0; }
    :root{ --primary:#0b5aa2; --accent:#e44d26; --bg:#ffffff; --muted:#f4f6f8; --text:#1f2937; --border:#e5e7eb; }
    header{ padding:20px 16px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#fff,#fafafa);}
    h1{ margin:0; font-size:1.4rem; color:#0b5aa2;}
    .container{ max-width:1100px; margin:0 auto; padding:16px;}
    .toolbar{ display:grid; gap:8px; grid-template-columns:1fr repeat(6,minmax(120px,180px)); align-items:center; margin:10px 0 14px;}
    .toolbar>*{ width:100%;}
    .view-toggle{ display:flex; gap:8px; }
    input,select,button,textarea{ padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:14px;}
    button{ cursor:pointer; border:1px solid var(--primary); background:var(--primary); color:#fff; font-weight:600;}
    button.secondary{ background:#fff; color:#0b5aa2; }
    button.ghost{ background:#fff; color:#374151; border:1px solid var(--border); }

    /* Dropdown catégories */
    .dropdown{ position:relative; }
    .dropdown-button{ display:flex; align-items:center; justify-content:space-between; gap:8px; border:1px solid var(--border); background:#fff; color:#111827; font-weight:500; }
    .dropdown-button .count{ background:#eef6ff; color:#0b5aa2; border:1px solid #dbeafe; border-radius:999px; padding:2px 8px; font-size:12px; }
    .dropdown-panel{ position:absolute; z-index:20; top:100%; left:0; right:0; margin-top:6px; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.08); padding:10px; display:none; max-height:320px; overflow:auto; }
    .dropdown.open .dropdown-panel{ display:block; }
    .dropdown .actions{ display:flex; gap:8px; margin-top:8px; }
    .checkrow{ display:flex; align-items:center; gap:8px; padding:6px 4px; }
    .checkrow:hover{ background:#fafafa; border-radius:8px; }
    .checkbox{ width:16px; height:16px; }
    .srch{ width:100%; margin-bottom:8px; }

    table{ width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    thead th{ text-align:left; background:var(--muted); border-bottom:1px solid var(--border); padding:10px; font-size:13px; color:#374151; user-select:none; cursor:pointer; }
    tbody td{ border-bottom:1px solid var(--border); padding:10px; font-size:14px; }
    tbody tr:hover{ background:#fcfcfd; }

    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;}
    .chip{ background:#eef6ff; color:#0b5aa2; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #dbeafe;}

    .footer{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:10px;}
    .pagination{ display:flex; gap:6px; }
    .pagination button{ padding:8px 10px; }

    .cards{ display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; }
    .card{ background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,0.04); display:flex; flex-direction:column; gap:8px; }
    .card h3{ margin:0; font-size:16px; color:#111827; }
    .badge{ display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#fafafa; }
    .kv{ font-size:13px; color:#374151; }
    .kv b{ color:#111827; font-weight:600; }
    .hidden{ display:none !important; }

    @media (max-width:1100px){ .cards{ grid-template-columns:repeat(2, 1fr);} }
    @media (max-width:700px){ .toolbar{ grid-template-columns:1fr 1fr; } .cards{ grid-template-columns:1fr; } }

    @media print {
      .toolbar,.footer{ display:none!important; }
      body{ background:#fff; }
      .card{ break-inside:avoid; }
      table{ box-shadow:none; }
    }

    /* === Couleurs par statut === */
    .status-open { background:#e6f9ec !important; }
    .status-intermittent { background:#fff3e0 !important; }
    .status-planned { background:#fdeaea !important; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="container">
        <h1>Essais cliniques</h1>
        <div class="chips" id="summary"></div>
        <div style="color:#6b7280;font-size:13px">Source : <code>essais.csv</code></div>
      </div>
    </header>

    <main class="container">
      <div class="toolbar">
        <input id="q" type="search" placeholder="Rechercher..." />
        <select id="phase"><option value="">Phase (toutes)</option></select>
        <select id="statut"><option value="">Statut (tous)</option></select>

        <div class="view-toggle">
          <button id="modeList" class="ghost">Liste</button>
          <button id="modeCards" class="ghost">Cartes</button>
        </div>

        <div style="display:flex; gap:8px;">
          <button id="exportCsv" class="secondary">Exporter CSV</button>
          <button id="exportJson" class="secondary">Exporter JSON</button>
          <button id="print">Imprimer</button>
        </div>
      </div>

      <table id="table" class="hidden">
        <thead>
          <tr>
            <th data-key="ID">ID</th>
            <th data-key="Titre">Titre</th>
            <th data-key="Phase">Phase</th>
            <th data-key="Statut">Statut</th>
            <th data-key="Categorie">Catégorie</th>
            <th data-key="Population">Population</th>
            <th data-key="Interventions">Interventions</th>
            <th data-key="Notes">Notes</th>
            <th data-key="Contact">Contact</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="cards" class="cards"></div>

      <div class="footer">
        <div id="count"></div>
        <div class="pagination">
          <button id="prev" class="secondary">Précédent</button>
          <span id="pageInfo"></span>
          <button id="next">Suivant</button>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
    let rows=[], filtered=[]; let sortKey=null, sortDir=1; const pageSize=10; let page=1; let mode='cards';

    function renderTable(){
      const total=filtered.length, tp=Math.max(1,Math.ceil(total/pageSize));
      page=Math.min(Math.max(1,page),tp);
      const sl=filtered.slice((page-1)*pageSize,page*pageSize);

      $('#table tbody').innerHTML=sl.map(r=>{
        const st=(r.Statut||'').toLowerCase();
        let cls='';
        if(st.includes('open')) cls='status-open';
        else if(st.includes('intermittent')) cls='status-intermittent';
        else if(st.includes('planned')||st.includes('plan')) cls='status-planned';

        return `<tr class="${cls}">
          <td>${r.ID??''}</td><td>${r.Titre??''}</td><td>${r.Phase??''}</td>
          <td>${r.Statut??''}</td><td>${r.Categorie??''}</td><td>${r.Population??''}</td>
          <td>${r.Interventions??''}</td><td>${r.Notes??''}</td><td>${r.Contact??''}</td>
        </tr>`;
      }).join('');
      $('#count').textContent=`${total} essai(s)`; $('#pageInfo').textContent=`Page ${page}/${tp}`;
    }

    function renderCards(){
      const total=filtered.length, tp=Math.max(1,Math.ceil(total/pageSize));
      page=Math.min(Math.max(1,page),tp);
      const sl=filtered.slice((page-1)*pageSize,page*pageSize);

      $('#cards').innerHTML=sl.map(r=>{
        const st=(r.Statut||'').toLowerCase();
        let cls='';
        if(st.includes('open')) cls='status-open';
        else if(st.includes('intermittent')) cls='status-intermittent';
        else if(st.includes('planned')||st.includes('plan')) cls='status-planned';

        return `<div class="card ${cls}">
          <h3>${r.Titre||'(Sans titre)'}</h3>
          <div class="kv"><b>Phase :</b> ${r.Phase||'—'}</div>
          <div class="kv"><b>Statut :</b> ${r.Statut||'—'}</div>
          <div class="kv"><b>Catégorie :</b> ${r.Categorie||'—'}</div>
          <div class="kv"><b>Population :</b> ${r.Population||'—'}</div>
          <div class="kv"><b>Interventions :</b> ${r.Interventions||'—'}</div>
          <div class="kv"><b>Notes :</b> ${r.Notes||'—'}</div>
          <div class="kv"><b>Contact :</b> ${r.Contact||'—'}</div>
        </div>`;
      }).join('');
      $('#count').textContent=`${total} essai(s)`; $('#pageInfo').textContent=`Page ${page}/${tp}`;
    }

    function render(){ if(mode==='list'){ $('#table').classList.remove('hidden'); $('#cards').classList.add('hidden'); renderTable(); } else { $('#cards').classList.remove('hidden'); $('#table').classList.add('hidden'); renderCards(); } }

    function applyFilters(){ filtered=rows; page=1; render(); }

    function loadCSV(){
      Papa.parse('essais.csv',{download:true,header:true,skipEmptyLines:true,
        complete:res=>{ rows=res.data; applyFilters(); }
      });
    }

    $('#modeList').addEventListener('click',()=>{mode='list';render();});
    $('#modeCards').addEventListener('click',()=>{mode='cards';render();});
    $('#prev').addEventListener('click',()=>{page--;render();});
    $('#next').addEventListener('click',()=>{page++;render();});
    $('#print').addEventListener('click',()=>window.print());

    loadCSV();
  </script>
</body>
</html>
